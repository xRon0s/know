<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authority</title>
    <link rel="stylesheet" href="css/style.css?v=1.4">
    <link rel="stylesheet" href="css/authority.css">
</head>
<body>
    <div class="scroll-indicator"></div>
    <header>
        <a href="homepage.html" class="logo">HomePage</a>
        <nav>
            <a href="goals.html">目標</a>
            <a href="image.html">構成図</a>
            <a href="preparation.html">準備</a>
            <a href="authority.html">権限</a>
            <a href="web.html">Web設定</a>
            <a href="trouble.html">トラブル</a>
        </nav>
    </header>

    <main>
        <h1>権限・鍵認証・ファイアウォール</h1>
        <section>
            <h2>1. ユーザー作成</h2>
            <p>今回のサーバー作成においては追加でユーザーを作成する必要が無いため、ユーザーは追加しません。</p>
        </section>
        <section>
            <h2>2. 権限</h2>
            <p>デフォルトのrootユーザーを用いる場合、初期からsudo権限を持っているため権限の付与は必要ありません。
            新規のユーザーで環境を作成する場合は以下のコマンドを用いる。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>sudo usermod -aG sudo [ユーザー名] <span class="code-comment"># 既存のユーザーをsudoグループに追加し、管理者権限を付与する</span></code>
                </div>
            </div>
            <p>(確認用コマンド)</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>groups [ユーザー名] <span class="code-comment"># ユーザーが所属するグループを確認する</span>
<span class="code-comment"># sudoが含まれていることを確認する</span></code>
                </div>
            </div>
        </section>
        <section>
            <h2>3. SSH接続</h2>
            <p>左上のラズパイアイコンからPreferences → Raspberry Pi Configuration の順にクリックするとRaspberry Pi Configurationが開くので、Interfacesをクリックし、SSHのトグルスイッチをクリックしてSSH接続を有効化します。</p>
            <p>SSH接続のために、鍵認証を設定します。以下のコマンドでed25519の鍵を生成します。（質問には全てEnterで答える）</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>ssh-keygen -t ed25519 <span class="code-comment"># ed25519方式のSSHキーペア（公開鍵と秘密鍵）を生成する</span></code>
                </div>
            </div>
            <p>root直下の.sshフォルダに公開鍵と秘密鍵が生成される。生成した公開鍵を転送・登録するために以下のコマンドを用います。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>ssh-copy-id -i ~/.ssh/id_ed25519.pub r23093@192.168.1.10 <span class="code-comment"># 公開鍵をリモートホストにコピーして、鍵認証を設定する</span></code>
                </div>
            </div>
            <p>もし、.ssh等などのフォルダ、ファイルが生成されていない場合、以下のコマンド等を用いて認証鍵を配置する。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>mkdir -p ~/.ssh <span class="code-comment"># .sshディレクトリを作成する（-pは親ディレクトリも同時に作成するオプション）</span>
cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys <span class="code-comment"># 公開鍵をauthorized_keysファイルに追記する</span>
chmod 600 ~/.ssh/authorized_keys <span class="code-comment"># authorized_keysファイルの権限を所有者のみ読み書き可能に設定する</span></code>
                </div>
            </div>
            <p>ブルートフォースアタックを防ぐために、ログインが可能かを確認した後にパスワードでのログインを禁止します。今回は別PCを用いなかったため、自分自身に接続テストします。以下のコマンドを用いてSSH接続を確認します。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>ssh r23093@localhost <span class="code-comment"># 自分自身（localhost）にSSH接続を試みる</span>
<span class="code-comment"># 新しいコマンドプロンプトで実行する</span>
ssh -p 2222 username@192.168.1.10 <span class="code-comment"># 指定したポート番号でSSH接続を試みる</span></code>
                </div>
            </div>
            <p>問題が無ければ、サーバー側のSSH設定を変更し、セキュリティをさらに強化します。</p>
            <div class="config-block">
                <div class="config-title">/etc/ssh/sshd_config</div>
                <div class="config-content"><span class="code-comment"># --- 設定内容 ---</span>
  Port 2222                 # SSHのポート番号を2222に変更
  #AddressFamily any         # (コメントアウト解除や確認: IPv4/IPv6のどちらも許可)
  ListenAddress 0.0.0.0       # (すべてのインターフェースからの接続を許可)
  
  PermitRootLogin no          # rootユーザーでのログインを禁止
  PasswordAuthentication no   # パスワード認証を無効化

  # 鍵認証を有効化していることを確認
  PubkeyAuthentication yes
  
  # authorized_keysのパスを確認
  AuthorizedKeysFile      .ssh/authorized_keys

  # Subsystem sftp /usr/lib/ssh/sftp-server # (確認: コメントアウトされていないことを確認)

<span class="code-comment"># --- ファイル情報 ---</span>
<span class="code-comment"># 所有者: root:root</span>
<span class="code-comment"># 権限: 644 (-rw-r--r--)</span>
</div>
            </div>
            <p>設定が完了したら、SSHサービスを再起動して設定を反映させます。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>sudo systemctl restart sshd</code>
                </div>
            </div>
            <p><strong>注意:</strong> この設定変更後、パスワードでのログインはできなくなります。また、SSH接続時のポート番号が変更されます。</p>

            <h3>3.4. 接続の簡略化</h3>
            <p>毎回ポート番号やユーザー名を入力するのは手間なので、クライアントPCの<code>~/.ssh/config</code>ファイルを編集して接続情報を保存します。</p>
            <div class="config-block">
                <div class="config-title">~/.ssh/config (クライアントPC側)</div>
                <div class="config-content"><span class="code-comment"># --- 設定内容 ---</span>
  Host myserver # 接続のエイリアス名
  HostName 192.168.1.10 # 接続先ホスト名（IPアドレス）
  User username # ユーザー名
  Port 2222 # ポート番号
  IdentityFile ~/.ssh/id_ed25519 # 使用する秘密鍵のパス
</div>
            </div>
            <p>これで、以下の簡単なコマンドで接続できるようになります。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>ssh myserver</code>
                </div>
            </div>
        </section>
        <section>
            <h2>4. ファイアウォール</h2>
            <p>UFW (Uncomplicated Firewall) を用いて、サーバーへのアクセスを制御します。デフォルトですべての受信を拒否し、必要なポートのみを許可します。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>sudo apt install ufw -y <span class="code-comment"># UFWをインストール</span>
sudo ufw default deny incoming <span class="code-comment"># デフォルトで全ての受信を拒否</span>
sudo ufw default allow outgoing <span class="code-comment"># 全ての送信は許可</span></code>
                </div>
            </div>
            <p>次に、SSH接続とWebサーバー用のポートを開放します。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>sudo ufw allow 2222/tcp <span class="code-comment"># SSH接続用に変更したポートを許可</span>
sudo ufw allow http <span class="code-comment"># Webサーバー用に80番ポート(HTTP)を許可</span>
sudo ufw allow https <span class="code-comment"># Webサーバー用に443番ポート(HTTPS)を許可</span></code>
                </div>
            </div>
            <p>最後に、UFWを有効化して設定を適用します。</p>
            <div class="command-prompt">
                <div class="command-prompt-header">
                    <div class="command-prompt-buttons">
                        <span class="close"></span><span class="minimize"></span><span class="maximize"></span>
                    </div>
                    <div class="command-prompt-title">terminal</div>
                </div>
                <div class="command-prompt-body">
                    <code>sudo ufw enable <span class="code-comment"># UFWを有効化</span>
sudo ufw status verbose <span class="code-comment"># 詳細な状態を確認</span></code>
                </div>
            </div>
        </section>
    </main>
    <script src="js/main.js"></script>
</body>
</html>
